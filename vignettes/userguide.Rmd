---
title: "Руководство пользователя"
output: 
  rmarkdown::html_vignette
params:
  archive_name: "ml_nowcasting_2021-10-04"
  tar_gz_archive_name: "rmedb_0.0.0.9000.tar.gz"
vignette: >
  %\VignetteIndexEntry{User Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

`rmedb` - пакет на языке R для парсинга открытых макроэкономических данных разной периодичности для России. 

 Источники:
 
 1. [Росстат](https://rosstat.gov.ru/): опросы, макроэкономческая статистика;
 
 2. [Московская биржа](https://moex.com/): биржевые индексы;
 
 3. [FRED](https://fred.stlouisfed.org/): индексы цен на товары, S&P 500, эффективный курс;
 
 4. [Federal Reserve Bank of Dallas](https://www.dallasfed.org/research/igrea): Index of Global Real Economic Activity;
 
 5. [Банк России](http://cbr.ru/): показатели денежного рынка, внешняя торговля в долларах, курсы валют;
 
 6. [OECD](https://data.oecd.org/): Composite leading indicator, Business confidence index, Consumer confidence index.

# Пакет rmedb

## Установка

### Установка R

R можно установить из официального репозитория [CRAN](https://cloud.r-project.org/). Скачайте и установите последнюю версию для вашей операционной системы.

> &#9888; **Желательно при установке выбрать английский язык**

> &#9888; **Избегайте кириллических символов при выборе директории для установки R** 


### Установка RStudio

RStudio - удобная среда для работы в R. [Скачайте](https://www.rstudio.com/products/rstudio/download/#download) бесплатную версию программы для вашей операционной системы и установите ее.


### Установка пакета (из архива)

Перед установкой пакета для парсинга установите вспомогательный пакет `devtools` (ниже показаны строчки кода, которые нужно скопировать и запустить в консоли R нажатием  <kbd>Enter</kbd>):
```{r, eval=FALSE}
install.packages("devtools")
```

После выполнения кода вы должны получить в выводе консоли строки примерно следующего содержания:

```{eval=FALSE}
package ‘devtools’ successfully unpacked and MD5 sums checked

The downloaded binary packages are in
	C:\Users\user\AppData\Local\Temp\RtmpYpeVjx\downloaded_packages
```

Если `devtools` успешно установлен, скачайте архив ``r params$archive_name`` и распакуйте его.

Установите пакет `rmedb` с помощью функции `install_local` из пакета `devtools` (в R для обращения напрямую к функциям пакета используется `::`), в аргументе `path` указав путь к файлу ``r params$tar_gz_archive_name``, который находится в распакованном архиве:
```{r, eval=FALSE}
devtools::install_local(path = "C:/PATH/TO/TAR.GZ")
```

> &#9888; **Для пользователей Windows:** В R при разделении имён директорий используется <kbd>/</kbd>

Если вы устанавливаете пакет из Rstudio, вам предложат скачать или обновить пакеты, неоходимые для работы. Подтвердите обновления в соответствии с текстом на экране. 

После выполнения кода вы получите в выводе консоли примерно следующие строки (возможно, вы найдете эти строки не в самом конце вывода):

```{eval=FALSE}
** building package indices
** testing if installed package can be loaded from temporary location
*** arch - i386
*** arch - x64
** testing if installed package can be loaded from final location
*** arch - i386
*** arch - x64
** testing if installed package keeps a record of temporary installation path
* DONE (rmedb)
```


### Задание глобальных переменных:

> &#9888; **Этот шаг не нужно выполнять, если вы обновляете прошлую версию пакета, а не устанавливаете его в первый раз** 

Некоторые из используемых в пакете рядов скачиваются из базы данных [FRED](https://fred.stlouisfed.org/). Для доступа к ним необходимо [получить](https://research.stlouisfed.org/docs/api/api_key.html) ключ API.
Более подробно об этом можно прочесть в [документации](https://cran.r-project.org/web/packages/fredr/vignettes/fredr.html#authentication) пакета для R `fredr`.

После установки пакета и получения ключа выполните команду, указав адрес рабочей директории `path` (в ней будут сохраняться все скачанные файлы) и ключ `fredr_api_key`:
```{r, eval=FALSE}
rmedb::set.environment(path = "C:/PATH/TO/WORKING/DIR", fredr_api_key = "YourFredrAPIKey")
# пробный ключ: b3253be67e9b6d9dfc03967a568b820f
```

> &#9888; **Избегайте кириллических символов при выборе директории** 

Директория будет создана, если еще не существует. Внутри директории появится папка `data` для всех скачанных рядов, а вы получите сообщения об успешном создании директории и задании глобальных переменных.

```{r, echo=FALSE}
message('Рабочая директория успешно создана: C:/PATH/TO/WORKING/DIR ')
message('Файл с глобальными переменными успешно создан: : C:/HOME/.Renviron')
```

#### Решение ошибок 

Если при выполнении функции `set.environment` вы получили одно из следующих сообщений, следуйте инструкциям.
 
##### Создание рабочей директории
```{r, echo=FALSE}
warning('Не удалось создать рабочую директорию: C:/PATH/TO/WORKING/DIR')
```
Измените путь к рабочей директории (возможно, вы указали директорию, которой нет доступа из R) и повторите выполнение функции `set.environment`.

##### Создание файла с глобальными переменными
```{r, echo=FALSE}
warning('Не удалось создать файл с глобальными переменными: C:/HOME/.Renviron')
```

возможно, возникла проблема с правами доступа в *домашнюю директорию* на вашем компьютере:

Для решения этой проблемы попробуйте вручную создать файл с глобальными переменными.
Найдите вашу *домашнюю директорию*:
```{r, eval=FALSE}
Sys.getenv('HOME')
```

Создайте в ней текстовый файл со следующим содержанием (замените значения после `=` на выбранный вами адрес рабочей директории и полученный ключ API, адрес директории указывайте без кавычек, избегайте лишних пробелов или пустых строк):

```
fredr_api_key=YourFredrAPIKey
directory=C:/PATH/TO/WORKING/DIR
```

Сохраните файл как `.Renviron` (проверьте, что файл сохранился именно с таким именем, а не, например, как `.Renviron.txt`).
Если получилось успешно сохранить файл, перезагрузите R (в Rstudio на верхней панели: `Session` -> `Restart R`) и проверьте, что глобальные переменные были созданы:

```{r, include=FALSE}
Sys.setenv("directory"="C:/PATH/TO/WORKING/DIR")
Sys.setenv("fredr_api_key"="YourFredrAPIKey")
```

```{r, eval=TRUE}
Sys.getenv("directory")
Sys.getenv("fredr_api_key")
```


Возможно, *домашняя директория* заблокирована для сохранения в ней файлов, в таком случае вам придется установить переменные *локально*. Для этого создайте проект в R (в Rstudio на верхней панели: `File` -> `New project` -> `New Directory`, если вы хотите создать новую директорию для запуска функций пакета из нее, или `File` -> `New project` -> `Existing Directory` если вы хотите работать с пакетом из уже существующей директории). После создания проекта создайте, как описано выше, файл `.Renviron` и сохраните его в папке, которая соответствует проекту.

После сохранения файла перезагрузите R (в Rstudio на верхней панели: `Session` -> `Restart R`) и проверьте, что глобальные переменные были созданы:

```{r, include=FALSE}
Sys.setenv("directory"="C:/PATH/TO/WORKING/DIR")
Sys.setenv("fredr_api_key"="YourFredrAPIKey")
```

```{r, eval=TRUE}
Sys.getenv("directory")
Sys.getenv("fredr_api_key")
```

> &#9888; **Если у вас получилось установить переменные только *локально*, то пакет будет работать корректно, только если вы запускаете функции пакета внутри соответствующего проекта**

При желании вы можете скопировать файл `.Renviron` в несколько проектов, или, если не хотите работать внутри проекта, при запуске сессии R выполнять следующие команды:

```{r, eval = FALSE}
Sys.setenv("directory"="C:/PATH/TO/WORKING/DIR")
Sys.setenv("fredr_api_key"="YourFredrAPIKey")
```

Последняя опция может быть полезна, если вы захотите настроить автоматическое обновление базы данных. В таком случае будет достаточно написать в начале запускаемого по расписанию скрипта эти строчки кода.


## Пример использования пакета
Показать список доступных переменных (применим функцию `head`, чтобы отображать только первые `5` строк таблицы):
```{r, eval=TRUE}
head(rmedb::show.variables(), 5)

```

В R удобно читать большую таблицу с помощью команды `View`:
```{r, eval=FALSE}
View(rmedb::show.variables())
```

Показать список источников:
```{r, eval=TRUE}
rmedb::sources
```

Скачать данные:
```{r, eval=FALSE}
rmedb::download() # скачать все доступные временные ряды
rmedb::download(tickers   = c("RTSI", "SP500")) # скачать ряды по тикеру
rmedb::download(sources = "cbr") # скачать все ряды по источнику
rmedb::download(tickers = "cli_RUS",sources = "dallasfed") # объединение источника и тикера
```


# Приложение

Для запуска shiny-приложения скачайте пакеты `shiny`, `ggplot2` и `xts`:
```{r, eval=FALSE}
install.packages("shiny", "ggplot2", "xts")
```

Запустите приложение, указав путь к распакованной папке с кодом приложения `rmedb_shiny` из исходного архива ``r params$archive_name`` (можно перенести папку `rmedb_shiny` в созданную ранее директорию).
```{r, eval=FALSE}
shiny::runApp("rmedb_shiny")
```


> &#9888; **Если у вас получилось установить переменные только *локально*, то папку с приложением надо разместить внутри проекта с файлом `.Renviron`**



# Структура рабочей директории
Как описано ранее, после установки пакета и запуска функции `set.environment()` создается рабочая директория, в которой сохраняются временные ряды, ее структура следующая:

- `data/`

  - `raw/`: файлы `ticker.csv` для каждого тикера, представляющие собой таблицу из трех колонок: `date: YYYY-mm-dd`, `value: numeric`, `update_date: YYYY-mm-dd`. `date` для недельных и дневных данных соответствует оригинальной дате, для квартальных и месячных данных `date` - это первый день соответствующего периода. `value` - оригинальное значение ряда, округленное до 5 знака после запятой. `update_date` - дата добавления значения в таблицу. При запуске функции  `download` с дефолтным значением аргумента `raw = TRUE` происходит обновление значений в папке `raw`. Обратите внимание на то, что в папку `raw` происходит запись только таких комбинаций (`date`, `value`), которые до этого не встречались в таблице. Некоторые переменные, в частности индексы OECD и Индекс глобальной экономической активности, каждый месяц пересчитываются для всех значений. Это означает, что соответствующие таблицы в папке `raw` будут полностью обновляться, а старые значения *удаляться не будут*. Кроме того, некоторые показатели Росстата периодически уточняются, и это уточнение будет учтено в папке `raw`: эти показатели будут иметь несколько значений для одного периода времени, в таком случае наиболее актуальным будет то значение, которое было добавлено позже остальных. При обновлении таблицы старые значения не перезаписываются, в связи с этим данные в файлах папки `raw` *не отсортированы* по времени.
  
  - `raw_excel/`: несколько папок, соответствующих отдельным таблицам из Росстата (тикеры таблиц смотрите в `rmedb::rosstat_tables`). При запуске функции  `download`, если для скачивания выбраны временные ряды из Росстата, сначала проверяется, обновлялся ли файл, в которой находятся значения этих рядов. Если на сайте Росстата доступная новая версия excel-файла для тикера `table`, она скачивается в папку `raw_excel/table` и сохраняется под именем `YYYY-mm-dd.xls(.xlsx)`, соответствующим дате обновления на сайте, и после этого csv-файл в папке `raw` обновляется на основе данных из excel-файла.
  
  - `tf/`: файлы `ticker.csv` для каждого тикера, представляющие собой таблицу из двух колонок: `date: YYYY-mm-dd`, `value: numeric`. В отличии от папки `raw`, в папке `tf` для каждой даты записано только одно, самое актуальное значение переменной. При запуске функции  `download` с дефолтным значением аргумента `transform = TRUE` происходит обновление значений в папке `tf`, причем каждая таблица записывается заново и сортируется по дате. Кроме этого, дневные ряды в пересчитываются в среднее с начала месяца, а индексы, в оригинальном виде предоставляемые в \% к предыдущему периоду, переводятся в цепной вид, где первая точка наблюдений соответствует значению 100.
  
  - `log/`: после каждого запуска функции `download`с дефолтным значением аргумента `raw = TRUE` в файлы `YYYY-mm-dd_HH_MM_SS.log`, названные по времени запуска функции, записывается краткий отчет по каждому из указанных тикеров: если скачивание прошло успешно, записывается количество скачанных строк, а если при скачивании тикера возникла ошибка, записывается сообщение об ошибке.
  
  - `info.csv`: таблица формата `update_date: YYYY-mm-dd`,`n: numeric`, `ticker: character`, где для каждого тикера и для каждой даты обновления указано, сколько новых строк было добавлено в файл в папке `raw` (запись появляется в таблице, только если количество добавленных строк ненулевое).


# Список переменных
```{r, echo  = FALSE}
DT::datatable(rmedb::show.variables(additional=TRUE, russificate=TRUE, url_as_href=TRUE),
              filter = 'top',
              colnames = c('Тикер','Название', 'Источник', 'Периодичность',  'Начало наблюдений', 'Ссылка', 'Комменатрий'),
              escape = FALSE,
              rownames=FALSE,
              options = list(rownames= FALSE,
                             autoWidth = TRUE,
                             language = list(url = 'http:/cdn.datatables.net/plug-ins/1.10.11/i18n/Russian.json'),
                             pageLength = 25
)
)
```
